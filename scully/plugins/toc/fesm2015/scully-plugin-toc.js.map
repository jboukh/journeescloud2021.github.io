{"version":3,"file":"scully-plugin-toc.js","sources":["../../../projects/scully-plugin-toc/src/lib/constants.ts","../../../projects/scully-plugin-toc/src/lib/toc.ts","../../../projects/scully-plugin-toc/src/lib/validator.ts","../../../projects/scully-plugin-toc/src/lib/index.ts","../../../projects/scully-plugin-toc/src/public-api.ts","../../../projects/scully-plugin-toc/src/scully-plugin-toc.ts"],"sourcesContent":["export const TocPluginName = 'toc';\n","import {\n  getPluginConfig,\n  HandledRoute,\n  log,\n  logWarn,\n  yellow,\n} from '@scullyio/scully';\nimport { JSDOM } from 'jsdom';\nimport { TocPluginName } from './constants';\nimport { Level, TocConfig } from './interfaces';\n\nexport const headingLevel = (tag: string): number | null => {\n  const match = tag.match(/(?!h)[123456]/g);\n  return match && match.length ? Number(match[0]) : null;\n};\n\nexport const tocPlugin = async (html: string, routeData: HandledRoute) => {\n  const tocConfig = getPluginConfig<TocConfig>(TocPluginName);\n\n  const route = routeData.route;\n  try {\n    const dom = new JSDOM(html);\n    const { window } = dom;\n\n    /**\n     * define insert point\n     */\n    let tocInsertPointSelector = '#toc';\n    if (!tocConfig.insertSelector) {\n      logWarn(`No \"insertSelector\" for \"toc\" provided, using default: \"#id\".`);\n    } else {\n      tocInsertPointSelector = tocConfig.insertSelector;\n    }\n\n    /**\n     * search for insert point\n     */\n    const insertPoint = window.document.querySelector(tocInsertPointSelector);\n    // in case <div id=\"toc\"></div> is not on the site\n    if (!insertPoint) {\n      log(\n        `Insert point with selector ${tocInsertPointSelector} not found. Skipping toc generation for route ${route}.`,\n      );\n      return html;\n    }\n\n    /**\n     * get headings for toc generation\n     */\n    let levels: Level[] = ['h2', 'h3'];\n    if (!tocConfig.level) {\n      logWarn(\n        `Option \"level\" for \"toc\" not set, using default: \"['h2', 'h3']\".`,\n      );\n    } else {\n      levels = tocConfig.level;\n    }\n    const possibleValues = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'];\n    let selector = '';\n    levels.forEach((level) => {\n      const lowerCased = level.toLowerCase();\n      if (possibleValues.indexOf(lowerCased) === -1) {\n        logWarn(\n          `Level \"${level}\" is not valid. It should be one of ${JSON.stringify(\n            possibleValues,\n          )}.`,\n        );\n      } else {\n        selector += tocConfig.blogAreaSelector\n          ? `${tocConfig.blogAreaSelector} ${lowerCased},`\n          : `${lowerCased},`;\n      }\n    });\n    // remove leading and trailing comma\n    selector = selector.replace(/(^,)|(,$)/g, '');\n    const headers = window.document.querySelectorAll(selector);\n\n    /**\n     * build nested ul, li list\n     */\n    let previousTag: number | null;\n    let toc = '';\n    headers.forEach((c: any) => {\n      const level = headingLevel(c.tagName);\n      const trailingSlash = tocConfig.trailingSlash ? '/' : '';\n      const onClickScrollIntoViewString = tocConfig.scrollIntoViewOnClick\n        ? ` onclick=\"document.getElementById('${c.id}').scrollIntoView();\"`\n        : '';\n      const baseLiEl = `<li${onClickScrollIntoViewString}><a href=\"${route}${trailingSlash}#${c.id}\">${c.textContent}</a></li>`;\n      if (previousTag && level && level > previousTag) {\n        toc += '<ul style=\"margin-bottom: 0px\">';\n      }\n      if (previousTag && level && level < previousTag) {\n        toc += '</ul>';\n      }\n      toc += baseLiEl;\n      previousTag = level;\n    });\n\n    /**\n     * append toc as child\n     */\n    const list = window.document.createElement('ul');\n    list.innerHTML = toc;\n    insertPoint.appendChild(list);\n\n    /**\n     * return new serialized HTML\n     */\n    return dom.serialize();\n  } catch (e) {\n    logWarn(`error in tocPlugin, didn't parse for route '${yellow(route)}'`);\n  }\n  // in case of failure return unchanged HTML to keep flow going\n  return Promise.resolve(html);\n};\n","import { getPluginConfig } from '@scullyio/scully';\n\nimport { TocConfig } from './interfaces';\nimport { TocPluginName } from './constants';\n\nexport const validator = async (/* conf */) => {\n  const tocConfig = getPluginConfig<TocConfig>(TocPluginName);\n  const errors: string[] = [];\n\n  if (!tocConfig.insertSelector.length) {\n    errors.push(\n      'Option \"insertSelector\" for \"toc\" must be a valid string (e.g. \"#toc\").',\n    );\n  }\n\n  if (!tocConfig.blogAreaSelector.length) {\n    errors.push(\n      'Option \"blogAreaSelector\" for \"toc\" must be a valid string (e.g. \".blog-content\").',\n    );\n  }\n\n  if (tocConfig.level && !tocConfig.level.length) {\n    errors.push(\n      `Option \"level\" for \"toc\" must be an array containing headings to list (e.g.: \"['h2', 'h3']\".`,\n    );\n  }\n\n  return errors;\n};\n","import { registerPlugin } from '@scullyio/scully';\n\nimport { TocPluginName } from './constants';\nimport { tocPlugin } from './toc';\nimport { validator } from './validator';\n\ndeclare var require: any;\n\n/**\n * register the plugin\n */\nregisterPlugin('render', TocPluginName, tocPlugin, validator);\n\nexport const getTocPlugin = () => TocPluginName;\n","/*\n * Public API Surface of scully-plugin-toc\n */\nexport { getTocPlugin } from './lib/index';\nexport { TocConfig } from './lib/interfaces';\nexport { TocPluginName } from './lib/constants';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}